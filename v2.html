<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Event Logger</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #f5f5f5;
  }
  h1 {
    margin-bottom: 15px;
  }
  #seatArea {
    position: relative;
    width: 100%;
    max-width: 800px;
    aspect-ratio: 2 / 1;
    background-color: white;
    border: 2px solid #333;
    margin-bottom: 20px;
    cursor: crosshair;
    border-radius: 6px;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    background-image:
      linear-gradient(to right, #ccc 1px, transparent 1px),
      linear-gradient(to bottom, #ccc 1px, transparent 1px);
    background-size: calc(100% / 25) calc(100% / 12);
  }
  .dot {
    position: absolute;
    width: 8px;
    height: 8px;
    background-color: black;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    opacity: 0.33;
  }
  .dot-last {
    position: absolute;
    width: 24px;
    height: 24px;
    background-color: rgba(255, 0, 0, 0.5);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    box-shadow: 0 0 8px rgba(255, 0, 0, 0.7);
  }
  .dot-highlight {
    position: absolute;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 255, 0.4);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    box-shadow: 0 0 10px rgba(0, 0, 255, 0.6);
    display: none;
  }
  #controls {
    margin-bottom: 10px;
  }
  #controls button {
    background: #555;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 12px;
    margin-right: 8px;
    cursor: pointer;
    font-size: 14px;
  }
  #controls button:hover {
    background: #333;
  }
  #controls button.danger {
    background: #f44336;
  }
  #controls button.danger:hover {
    background: #d32f2f;
  }
  #logList {
    list-style: none;
    padding: 0;
    max-width: 800px;
  }
  #logList li {
    background: white;
    margin-bottom: 8px;
    padding: 10px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    transition: background-color 0.3s ease;
  }
  #logList li.highlighted {
    background-color: rgba(0, 0, 255, 0.15);
  }
</style>
</head>
<body>

<h3 style="width: auto; max-width: 800px; text-align: center;">DRINKING EVENT LOGGER</h3>
<div style="width: auto; max-width: 800px; text-align: center;">STAGE</div>
<div id="seatArea"></div>

<div id="controls">
  <button id="removeSelectedBtn" class="danger">Remove Selected</button>
  <button id="removeAllBtn" class="danger">Remove All</button>
  <button id="exportBtn">Export CSV</button>
</div>

<ul id="logList"></ul>

<script>
  const seatArea = document.getElementById('seatArea');
  const logList = document.getElementById('logList');
  const removeSelectedBtn = document.getElementById('removeSelectedBtn');
  const removeAllBtn = document.getElementById('removeAllBtn');
  const exportBtn = document.getElementById('exportBtn');

  let logData = JSON.parse(localStorage.getItem('seatLogs') || '[]');
  let highlightedIndex = null;

  const highlightDot = document.createElement('div');
  highlightDot.className = 'dot-highlight';
  seatArea.appendChild(highlightDot);

  function saveData() {
    localStorage.setItem('seatLogs', JSON.stringify(logData));
  }

  function renderDots() {
    seatArea.querySelectorAll('.dot, .dot-last').forEach(dot => dot.remove());

    logData.forEach((entry) => {
      const dot = document.createElement('div');
      dot.classList.add('dot');
      dot.style.left = (entry.x * 100) + '%';
      dot.style.top = (entry.y * 100) + '%';
      seatArea.appendChild(dot);
    });

    if (logData.length > 0) {
      const last = logData[logData.length - 1];
      const lastDot = document.createElement('div');
      lastDot.classList.add('dot-last');
      lastDot.style.left = (last.x * 100) + '%';
      lastDot.style.top = (last.y * 100) + '%';
      seatArea.appendChild(lastDot);
    }
  }

  function clearHighlight() {
    highlightedIndex = null;
    highlightDot.style.display = 'none';
    document.querySelectorAll('#logList li.highlighted').forEach(li => li.classList.remove('highlighted'));
  }

  function setHighlight(index) {
    highlightedIndex = index;
    const entry = logData[index];
    if (!entry) return;

    highlightDot.style.left = (entry.x * 100) + '%';
    highlightDot.style.top = (entry.y * 100) + '%';
    highlightDot.style.display = 'block';

    document.querySelectorAll('#logList li').forEach((li, i) => {
      li.classList.toggle('highlighted', i === (logData.length - 1 - index));
    });
  }

  function renderLog() {
    logList.innerHTML = '';
    [...logData].reverse().forEach((entry, i) => {
      const idx = logData.length - 1 - i;
      const li = document.createElement('li');
      li.innerHTML = `
        <span>
          <b>${idx+1}</b>
          ${entry.timestamp}
        </span>
      `;

      li.addEventListener('mouseenter', () => {
        if (highlightedIndex === null) {
          highlightDot.style.left = (entry.x * 100) + '%';
          highlightDot.style.top = (entry.y * 100) + '%';
          highlightDot.style.display = 'block';
          li.classList.add('highlighted');
        }
      });
      li.addEventListener('mouseleave', () => {
        if (highlightedIndex === null) {
          highlightDot.style.display = 'none';
          li.classList.remove('highlighted');
        }
      });

      li.addEventListener('click', () => {
        if (highlightedIndex === idx) {
          clearHighlight();
        } else {
          setHighlight(idx);
        }
      });

      logList.appendChild(li);
    });
  }

  seatArea.addEventListener('click', e => {
    const rect = seatArea.getBoundingClientRect();
    const x = (e.clientX - rect.left) / rect.width;
    const y = (e.clientY - rect.top) / rect.height;
    const timestamp = new Date().toISOString();

    logData.push({ x, y, timestamp });
    saveData();
    renderLog();
    renderDots();
    clearHighlight();
  });

  removeSelectedBtn.addEventListener('click', () => {
    if (highlightedIndex === null) {
      alert('No item selected to remove.');
      return;
    }
    if (confirm('Remove the selected item?')) {
      logData.splice(highlightedIndex, 1);
      saveData();
      renderLog();
      renderDots();
      clearHighlight();
    }
  });

  removeAllBtn.addEventListener('click', () => {
    const password = prompt('Enter password to remove all:');
    if (password === 'ichbinmirsicher') {
      logData = [];
      saveData();
      renderLog();
      renderDots();
      clearHighlight();
    } else if (password !== null) {
      alert('Incorrect password.');
    }
  });

  exportBtn.addEventListener('click', () => {
    if (logData.length === 0) {
      alert('No data to export.');
      return;
    }
    const csvRows = [['X', 'Y', 'Timestamp']];
    logData.forEach(entry => {
      csvRows.push([entry.x.toFixed(3), entry.y.toFixed(3), entry.timestamp]);
    });
    const csvContent = csvRows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'seat_log.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  renderLog();
  renderDots();
</script>

</body>
</html>