<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bus Observation Logger</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      max-width: 600px;
    }
    h1 { font-size: 1.5em; }
    input, button {
      margin: 0.5em 0;
      padding: 0.5em;
      font-size: 1em;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      padding: 0.5em;
      border-bottom: 1px solid #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .entry-text {
      flex: 1;
    }
    .delete-btn {
      margin-left: 1em;
      background: red;
      color: white;
      border: none;
      padding: 0.3em 0.6em;
      cursor: pointer;
    }
    #summary {
      font-size: 0.9em;
      color: #555;
      margin-left: 1em;
    }
    #actions {
      margin-top: 1em;
    }
  </style>
</head>
<body>
  <h1>Bus Observation Logger</h1>

  <div>
    <label>
      Number of people in bus:
      <input type="number" id="peopleInput" min="0">
    </label>
    <button onclick="addPeople()">Log People</button>
  </div>

  <div>
    <button onclick="addDrinking()">Log Drinking Event</button>
    <button onclick="addAdvertisement()">Log Advertisement Event</button>
  </div>

  <h2>
    Log 
    <span id="summary"></span>
  </h2>
  <ul id="logList"></ul>

  <div id="actions">
    <button onclick="downloadCSV()">Download Log as CSV</button>
    <button onclick="clearAll()" style="background: darkred; color: white;">Clear All Logs</button>
  </div>

  <script>
    const logList = document.getElementById('logList');
    const summaryEl = document.getElementById('summary');
    let log = JSON.parse(localStorage.getItem('busLog') || '[]');

    function saveLog() {
      localStorage.setItem('busLog', JSON.stringify(log));
    }

    function renderSummary() {
      const drinkingCount = log.filter(e => e.type === 'Drinking event').length;
      const adCount = log.filter(e => e.type === 'Advertisement event').length;
      const lastPeople = [...log].reverse().find(e => e.type === 'People in bus');
      const lastPeopleValue = lastPeople ? lastPeople.value : 'N/A';
      summaryEl.textContent = `(Drinking events: ${drinkingCount}, Ads shown: ${adCount}, Last people count: ${lastPeopleValue})`;
    }

    function renderLog() {
      logList.innerHTML = '';
      // newest first
      [...log].reverse().forEach((entry, indexFromEnd) => {
        const actualIndex = log.length - 1 - indexFromEnd;
        const li = document.createElement('li');
        const text = document.createElement('span');
        text.className = 'entry-text';
        text.textContent = `[${entry.timestamp}] ${entry.type}: ${entry.value}`;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'delete-btn';
        delBtn.onclick = () => {
          if (confirm("Are you sure you want to delete this entry?")) {
            log.splice(actualIndex, 1);
            saveLog();
            renderLog();
          }
        };
        li.appendChild(text);
        li.appendChild(delBtn);
        logList.appendChild(li);
      });
      renderSummary();
    }

    function addPeople() {
      const input = document.getElementById('peopleInput');
      const value = input.value.trim();
      if (value === '') return;
      const entry = {
        type: 'People in bus',
        value: value,
        timestamp: new Date().toLocaleString()
      };
      log.push(entry);
      saveLog();
      renderLog();
      input.value = '';
    }

    function addDrinking() {
      const entry = {
        type: 'Drinking event',
        value: 'Yes',
        timestamp: new Date().toLocaleString()
      };
      log.push(entry);
      saveLog();
      renderLog();
    }

    function addAdvertisement() {
      const entry = {
        type: 'Advertisement event',
        value: 'Shown',
        timestamp: new Date().toLocaleString()
      };
      log.push(entry);
      saveLog();
      renderLog();
    }

    function downloadCSV() {
      const header = "Timestamp,Type,Value\n";
      const rows = log.map(e => 
        `"${e.timestamp}","${e.type}","${e.value}"`
      ).join("\n");
      const csvContent = header + rows;
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "bus_log.csv");
      link.click();
    }

    function clearAll() {
      if (confirm("Are you sure you want to clear the entire log? This cannot be undone.")) {
        log = [];
        saveLog();
        renderLog();
      }
    }

    // Render on load
    renderLog();
  </script>
</body>
</html>
